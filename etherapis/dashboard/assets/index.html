<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Ether APIs Dashboard</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.6/slate/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </head>
  <body style="padding: 64px 0 0 0">
    <div id="content"></div>

    <script type="text/babel">
      var EthereumPeers = React.createClass({
        refreshPeers: function() {
          this.props.ajax(this.props.url, function(data) { this.setState({data: data.length}); }.bind(this));
        },
        getInitialState: function() {
          return {data: 0};
        },
        componentDidMount: function() {
          this.refreshPeers();
          setInterval(this.refreshPeers, this.props.refresh);
        },
        render: function() {
          return (<span className="navbar-text"><i className="fa fa-rss"></i> {this.state.data} peers</span>);
        }
      });

      var EthereumBlocks = React.createClass({
        refreshBlocks: function() {
          this.props.ajax(this.props.url, function(block) { this.setState({block: block}); }.bind(this));
        },
        getInitialState: function() {
          return {block: {number: 0, timestamp: 0}};
        },
        componentDidMount: function() {
          this.refreshBlocks();
          setInterval(this.refreshBlocks, this.props.refresh);
        },
        render: function() {
          return (
            <span>
              <span className="navbar-text"><i className="fa fa-database"></i> {parseInt(this.state.block.number, 16)} blocks</span>
              <span className="navbar-text"><i className="fa fa-clock-o"></i> {moment.unix(this.state.block.timestamp).fromNow()}</span>
            </span>
          );
        }
      });

      var ErrorAlert = React.createClass({
        render: function() {
          if (this.props.hide) {
            return null
          }
          return (
            <div className="row">
              <div className="col-lg-3"></div>
              <div className="col-lg-6">
                <div className="alert alert-danger text-center" role="alert">
                  <i className="fa fa-exclamation-triangle"></i> Backend offline, please check console for details...
                </div>
              </div>
            </div>
          )
        }
      });

      var Proxy = React.createClass({
        render: function() {
          return (
            <div className="col-lg-4">
              <div className={this.props.online ? "panel panel-success" : "panel panel-default"}>
                <div className="panel-heading">
                  <h3 className="panel-title">{this.props.name}: {this.props.online ? "Online" : "Offline"}</h3>
                </div>
                <div className="panel-body">
                  Proxy stats go here...
                </div>
              </div>
            </div>
          )
        }
      });

      var Proxies = React.createClass({
        render: function() {
          if (this.props.hide) {
            return null
          }
          return (
            <div>
              <div className="row">
                <div className="col-lg-12">
                  <h3>Payment proxies</h3>
                </div>
              </div>
              <div className="row">
                <Proxy name={"Geolocator demo"} online={true}/>
                <Proxy name={"Streamer demo"} online={false}/>
              </div>
            </div>
          )
        }
      });

      var Vault = React.createClass({
        render: function() {
          if (this.props.hide) {
            return null
          }
          return (
            <div>
              <div className="row">
                <div className="col-lg-12">
                  <h3>Payment vault</h3>
                  <div className="panel panel-default">
                    <div className="panel-body">
                      <table className="table table-striped table-hover ">
                        <thead>
                          <tr>
                            <th>Service</th>
                            <th>Subscriber</th>
                            <th>Owed</th>
                            <th>Limit</th>
                            <th>Total paid</th>
                            <th>Last request</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>Geolocator demo</td>
                            <td>0x3903a55e0802f011077bb33382822937d94efb7f</td>
                            <td>314 Finney</td>
                            <td>500 Finney</td>
                            <td>1.1 Ether</td>
                            <td>5 minutes ago</td>
                          </tr>
                          <tr>
                            <td>Geolocator demo</td>
                            <td>0x9fc6fefd7f33ca29ee17f2bfec944695e5f29caf</td>
                            <td>1.1 Ether</td>
                            <td>10 Ether</td>
                            <td>101 Ether</td>
                            <td>a few seconds ago</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        }
      });

      var Market = React.createClass({
        render: function() {
          if (this.props.hide) {
            return null
          }
          return (
            <div className="panel panel-default">
              <div className="panel-heading">
                <h3 className="panel-title">API Market</h3>
              </div>
              <div className="panel-body">
                Yeah, you wish... :P
              </div>
            </div>
          );
        }
      });

      var Dashboard = React.createClass({
        getInitialState: function() {
          return {
            index: false, market: true,
            apiOnline: true, apiFailure: ""};
        },
        loadIndex: function() {
          this.setState({index: false, market: true});
        },
        loadMarket: function() {
          this.setState({index: true, market: false});
        },
        apiCall: function(url, success) {
          $.ajax({url: url, dataType: 'json', cache: false,
            success: function(data) {
              if (this.state.apiFailure == url) {
                this.setState({apiOnline: true, apiFailure: ""});
              }
              success(data)
            }.bind(this),
            error: function(xhr, status, err) {
              this.setState({apiOnline: false, apiFailure: url});
              console.error(url, status, err.toString());
            }.bind(this)
          });
        },
        render: function() {
          return (
            <div>
              <nav className="navbar navbar-fixed-top">
                <div className="container">
                  <div className="navbar-header">
                    <a className="navbar-brand" href="#" onClick={this.loadIndex}>Ether APIs Dashboard</a>
                  </div>
                  <div id="navbar" className="navbar-collapse collapse">
                    <ul className="nav navbar-nav">
                      <li><a href="#" onClick={this.loadMarket}><i className="fa fa-shopping-basket"></i> API Market</a></li>
                    </ul>
                    <div className="navbar-right">
                      <EthereumPeers ajax={this.apiCall} url="/api/v0/ethereum/peers" refresh={1000}/>
                      <EthereumBlocks ajax={this.apiCall} url="/api/v0/ethereum/head" refresh={1000}/>
                    </div>
                  </div>
                </div>
              </nav>
              <div className="container">
                <ErrorAlert hide={this.state.apiOnline}/>
                <Proxies hide={this.state.index}/>
                <Vault hide={this.state.index}/>
                <Market hide={this.state.market}/>
              </div>
            </div>
          );
        }
      });
      var dashboard = ReactDOM.render(<Dashboard />, document.getElementById('content'));
      dashboard.setState({error: "Hi"})
    </script>
  </body>
</html>
